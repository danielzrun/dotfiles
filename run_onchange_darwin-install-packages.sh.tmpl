{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# =============================================================================
# Homebrew Package Installation
# =============================================================================
# Hash check: only runs when Brewfile changes
# Brewfile hash: {{ include "dot_config/brew/Brewfile" | sha256sum }}

# Check if Homebrew is installed
if ! command -v brew >/dev/null 2>&1; then
    echo "âš ï¸  Homebrew not found. Installing Homebrew first..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for Apple Silicon
    if [[ -d "/opt/homebrew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Sync packages
echo "ğŸ“¦ Syncing Homebrew packages from Brewfile..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
brew bundle --file={{ .chezmoi.sourceDir }}/dot_config/brew/Brewfile --verbose
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Install Oh My Zsh if not present
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo ""
    echo "ğŸ“¥ Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    echo "âœ… Oh My Zsh installed"
fi

# Install Oh My Zsh plugins
PLUGINS_DIR="$HOME/.oh-my-zsh/custom/plugins"

install_plugin() {
    local name=$1
    local repo=$2
    local target="$PLUGINS_DIR/$name"

    if [ ! -d "$target" ]; then
        echo "ğŸ“¥ Installing plugin: $name..."
        git clone --depth=1 "$repo" "$target"
    else
        echo "âœ“ Plugin already installed: $name"
    fi
}

echo ""
echo "ğŸ“¦ Installing Oh My Zsh plugins..."
install_plugin "zsh-autosuggestions" "https://github.com/zsh-users/zsh-autosuggestions"
install_plugin "zsh-completions" "https://github.com/zsh-users/zsh-completions"
install_plugin "fzf-tab" "https://github.com/Aloxaf/fzf-tab"
install_plugin "zsh-syntax-highlighting" "https://github.com/zsh-users/zsh-syntax-highlighting"

echo ""
echo "âœ… Package installation complete!"

{{- end -}}
